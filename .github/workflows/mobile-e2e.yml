# CI workflow for mobile (React Native / Expo) E2E tests.
# Runs Detox tests on iOS simulator and Android emulator.
#
# Trigger: Pushes to main, PRs touching app/native code, manual dispatch,
#          repository_dispatch (core-updated) from llamenos-core.
# Epic 88: Desktop & Mobile E2E Tests.
# Epic 104: Mobile E2E Test Expansion — CI fixes.
# Epic 116: Cross-Repo CI Integration.

name: Mobile E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'app/**'
      - 'e2e/**'
      - '__tests__/**'
      - 'modules/**'
      - '.detoxrc.js'
      - '.github/workflows/**'
      - 'package.json'
      - 'bun.lock'
  pull_request:
    paths:
      - 'src/**'
      - 'app/**'
      - 'e2e/**'
      - '__tests__/**'
      - 'modules/**'
      - '.detoxrc.js'
      - '.github/workflows/**'
      - 'package.json'
      - 'bun.lock'
  repository_dispatch:
    types: [core-updated]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ios:
    runs-on: macos-26
    name: E2E (iOS Simulator)
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test:unit

      - name: Install applesimutils
        run: brew tap wix/brew && brew install applesimutils

      - name: Download llamenos-core native libs (iOS)
        run: ./scripts/download-core-libs.sh ios
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Expo prebuild (generate ios/ and android/ dirs)
        run: bunx expo prebuild --no-install --platform ios

      - name: Cache CocoaPods
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        id: pods-cache
        with:
          path: |
            ios/Pods
            ios/Podfile.lock
          key: pods-${{ runner.os }}-${{ hashFiles('bun.lock', 'app.json', 'modules/**/ios/*.podspec') }}
          restore-keys: |
            pods-${{ runner.os }}-

      - name: Install CocoaPods
        if: steps.pods-cache.outputs.cache-hit != 'true'
        run: cd ios && pod install --repo-update

      - name: Boot iOS simulator
        id: boot-sim
        run: |
          # List available runtimes and device types for debugging
          echo "=== Available iOS runtimes ==="
          xcrun simctl list runtimes | grep -i ios || true
          echo ""
          echo "=== Available iPhone device types ==="
          xcrun simctl list devicetypes | grep -i iphone || true
          echo ""

          # Find any available iPhone simulator, preferring iPhone 16, then latest
          DEVICE_INFO=$(xcrun simctl list devices available -j | \
            python3 -c "
          import json, sys
          devs = json.load(sys.stdin)['devices']
          iphones = []
          for v in devs.values():
              for d in v:
                  if 'iPhone' in d['name'] and d['isAvailable']:
                      iphones.append(d)
          # Prefer iPhone 16, then sort by name descending (latest model first)
          preferred = [d for d in iphones if 'iPhone 16' in d['name']]
          if preferred:
              chosen = preferred[0]
          elif iphones:
              iphones.sort(key=lambda d: d['name'], reverse=True)
              chosen = iphones[0]
          else:
              chosen = None
          if chosen:
              print(f\"{chosen['udid']}|{chosen['name']}\")
          else:
              print('')
          ")

          if [ -n "$DEVICE_INFO" ]; then
            DEVICE_ID="${DEVICE_INFO%%|*}"
            DEVICE_NAME="${DEVICE_INFO##*|}"
            echo "Found existing simulator: $DEVICE_NAME ($DEVICE_ID)"
          else
            # No iPhone simulator found — create one with the latest runtime
            RUNTIME=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; rts=json.load(sys.stdin)['runtimes']; ios=[r for r in rts if r['platform']=='iOS' and r['isAvailable']]; print(ios[-1]['identifier'] if ios else '')")
            echo "Creating iPhone 16 simulator with runtime: $RUNTIME"
            DEVICE_ID=$(xcrun simctl create "iPhone 16" "com.apple.CoreSimulator.SimDeviceType.iPhone-16" "$RUNTIME" 2>&1) || {
              # If iPhone 16 type doesn't exist, try to find any available iPhone type
              DEVICE_TYPE=$(xcrun simctl list devicetypes -j | python3 -c "import json,sys; dts=json.load(sys.stdin)['devicetypes']; iphones=[d for d in dts if 'iPhone' in d['name']]; print(iphones[-1]['identifier'] if iphones else '')")
              DEVICE_NAME=$(xcrun simctl list devicetypes -j | python3 -c "import json,sys; dts=json.load(sys.stdin)['devicetypes']; iphones=[d for d in dts if 'iPhone' in d['name']]; print(iphones[-1]['name'] if iphones else 'iPhone')")
              echo "Falling back to device type: $DEVICE_NAME ($DEVICE_TYPE)"
              DEVICE_ID=$(xcrun simctl create "$DEVICE_NAME" "$DEVICE_TYPE" "$RUNTIME")
            }
            DEVICE_NAME="${DEVICE_NAME:-iPhone 16}"
          fi

          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" 2>/dev/null || true

          # Extract the device type name for Detox (e.g., "iPhone 16" or "iPhone 17")
          DETOX_DEVICE="${DEVICE_NAME:-iPhone 16}"
          echo "DETOX_IOS_DEVICE_TYPE=$DETOX_DEVICE" >> "$GITHUB_ENV"
          echo "Using Detox device type: $DETOX_DEVICE"

      - name: Build for Detox (iOS Release)
        run: bunx detox build --configuration ios.sim.release

      - name: Run Detox tests (iOS)
        run: bunx detox test --configuration ios.sim.release --cleanup --headless
        env:
          DETOX_LOGLEVEL: verbose
          DETOX_IOS_DEVICE_TYPE: ${{ env.DETOX_IOS_DEVICE_TYPE }}

      - name: Upload Detox artifacts
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: detox-ios-artifacts
          path: artifacts/
          retention-days: 3

  android:
    runs-on: ubuntu-latest
    name: E2E (Android Emulator)
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.2
        with:
          bun-version: "1.3.5"

      - name: Set up JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test:unit

      - name: Enable KVM for Android emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-34-${{ runner.os }}

      - name: Create AVD
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@b530d96654c385303d652368551fb075bc2f0b6b # v2.35.0
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_7
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot
          disable-animations: true
          script: echo "AVD created"

      - name: Download llamenos-core native libs (Android)
        run: ./scripts/download-core-libs.sh android
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Expo prebuild (generate android/ dir)
        run: bunx expo prebuild --no-install --platform android

      - name: Cache Gradle wrapper + dependencies
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Pre-bundle JS for Android
        run: |
          mkdir -p android/app/src/main/assets
          bunx react-native bundle \
            --platform android \
            --dev true \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res
          echo "Bundle created at android/app/src/main/assets/index.android.bundle"
          ls -la android/app/src/main/assets/

      - name: Build for Detox (Android Debug)
        run: bunx detox build --configuration android.emu.debug

      - name: Run Detox tests (Android)
        uses: reactivecircus/android-emulator-runner@b530d96654c385303d652368551fb075bc2f0b6b # v2.35.0
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_7
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot
          disable-animations: true
          script: bunx detox test --configuration android.emu.debug --cleanup --headless
        env:
          DETOX_LOGLEVEL: verbose

      - name: Upload Detox artifacts
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: detox-android-artifacts
          path: artifacts/
          retention-days: 3
